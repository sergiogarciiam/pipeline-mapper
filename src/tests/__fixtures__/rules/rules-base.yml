stages:
  - prepare
  - build
  - test
  - deploy

prepare:
  stage: prepare

build:
  stage: build
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

test1:
  stage: test
  rules:
    - changes:
      - src/**/*.ts
      - package.json

test2:
  stage: test
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: never

deploy:
  stage: deploy
  rules:
    - exists:
        - Dockerfile
        - helm/Chart.yaml